{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Storico Modifiche: {{ note.title }}</h3>
    <a href="/" class="btn btn-secondary">← Torna alle note</a>
</div>

<div class="card mb-4 border-primary">
    <div class="card-header bg-primary text-white">Versione Corrente</div>
    <div class="card-body markdown-container">
        <textarea class="raw-content d-none">{{ note.content }}</textarea>
        <div class="rendered-html"></div>
    </div>
</div>

<h4>Versioni Precedenti</h4>
{% if not history %}
    <p class="text-muted">Nessuna versione precedente salvata.</p>
{% else %}
    <div class="list-group">
    {% for version in history %}
        <div class="list-group-item list-group-item-action flex-column align-items-start">
            <div class="d-flex w-100 justify-content-between">
                <h5 class="mb-1">Versione archiviata</h5>
                <small class="text-muted">{{ version.date_archived.strftime('%d/%m/%Y %H:%M:%S') }}</small>
            </div>
            
            <div class="markdown-container mt-2">
                <textarea class="raw-content d-none">{{ version.content }}</textarea>
                <div class="rendered-html text-muted"></div>
            </div>
        </div>
    {% endfor %}
    </div>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Trova tutti i contenitori che devono mostrare Markdown
        document.querySelectorAll('.markdown-container').forEach(container => {
            // Prende il valore dalla textarea nascosta (questo metodo è sicuro per testi lunghi e caratteri speciali)
            const rawContent = container.querySelector('.raw-content').value;
            const targetDiv = container.querySelector('.rendered-html');
            
            // Se c'è contenuto, lo converte (Marked) e lo pulisce (DOMPurify) per sicurezza
            if(rawContent && targetDiv) {
                targetDiv.innerHTML = DOMPurify.sanitize(marked.parse(rawContent));
            }
        });
    });
</script>
{% endblock %}
